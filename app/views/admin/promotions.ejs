<!DOCTYPE html>
<html lang="en">

<head>
    <% include layouts/header %>           
    <!-- Bootstrap Daterangepicker CSS -->
	<link href="/static/admin/libs/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet" type="text/css"/>
</head>

<body>
    <!--Preloader-->
    <div class="preloader-it">
        <div class="la-anim-1"></div>
    </div>
    <!--/Preloader-->
    <div class="wrapper theme-5-active pimary-color-green">
        <% include layouts/menu %>
            <!-- Main Content -->
            <div class="page-wrapper">
                <div class="container-fluid">
                    <!-- Title -->
                    <div class="row heading-bg">
                        <div class="col-lg-3 col-md-4 col-sm-4 col-xs-12" style="width: 100%">
                            <h5 class="txt-dark" style="float: left;">Trang quản lý khuyến mãi</h5>
                            <button type="button" class="btn btn-primary" style="float: right" id="promotion-add">Thêm mới</button>
                        </div>
                    </div>
                    <!-- /Title -->
                     <!-- Modal -->
                     <div id="add-promotion-modal" class="modal fade in" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                        <h5 class="modal-title" id="myModalLabel">Thêm khuyến mãi</h5>
                                    </div>
                                    <div class="modal-body">
                                        <!-- Row -->
                                        <div class="row">
                                            <div class="col-lg-12">
                                                <div class="">
                                                    <div class="panel-wrapper collapse in">
                                                        <div class="panel-body pa-0">
                                                            <div class="col-sm-12 col-xs-12">
                                                                <div class="form-wrap">
                                                                    <form action="#">
                                                                        <div class="form-body overflow-hide">
                                                                            <div class="form-group">
                                                                                <label class="control-label mb-10" for="promo_code">Mã khuyến mãi</label>
                                                                                <div class="input-group">
                                                                                    <div class="input-group-addon"><i class="icon-user"></i></div>
                                                                                    <input type="text" class="form-control" id="promo_code" placeholder="ALOMOBILE" required>
                                                                                </div>
                                                                            </div>
                                                                            <div class="form-group">
                                                                                    <label class="control-label mb-10" for="description_promo">Mô tả</label>
                                                                                    <div class="input-group">
                                                                                        <div class="input-group-addon"><i class="icon-user"></i></div>
                                                                                        <input type="text" class="form-control" id="description_promo" placeholder="" required>
                                                                                    </div>
                                                                            </div>
                                                                            <div class="form-group">
                                                                                    <label class="control-label mb-10">Thời gian khuyến mãi</label>
                                                                                    <input type="text" class="form-control input-daterange-timepicker" name="daterange" value="01/01/2018 1:30 PM - 01/10/2018 2:00 PM"/>
                                                                                </div>
                                                                            <div class="form-group">
                                                                                <label class="control-label mb-10" for="type_promo">Loại khuyến mãi</label>
                                                                                <div>
                                                                                        <div class="radio">
                                                                                            <input type="radio" name="radio1" id="percent" value="percent" class="checked" checked>
                                                                                            <label for="percent">
                                                                                            Theo phần trăm
                                                                                            </label>
                                                                                        </div>
                                                                                        <div class="radio">
                                                                                            <input type="radio" name="radio1" id="price" value="price">
                                                                                            <label for="price">
                                                                                            Theo giá tiền
                                                                                            </label>
                                                                                        </div>
                                                                                    </div>
                                                                            </div>
                                                                            <div class="form-group">
                                                                                <label class="control-label mb-10" for="discount_promo">Phần trăm/giá khuyến mãi</label>
                                                                                <div class="input-group">
                                                                                    <div class="input-group-addon"><i class="icon-phone"></i></div>
                                                                                    <input type="text" class="form-control" id="discount_promo" placeholder="200000" required>
                                                                                </div>
                                                                            </div>
                                                                            <div class="form-group">
                                                                                <label class="control-label mb-10" for="limit_promo">Số lượng sử dụng tối đa</label>
                                                                                <div class="input-group">
                                                                                    <div class="input-group-addon"><i class="icon-lock"></i></div>
                                                                                    <input type="text" class="form-control" id="limit_promo" placeholder="2000" value="">
                                                                                </div>
                                                                            </div>      
                                                                            <div class="form-group">
                                                                                <label class="control-label mb-10" for="total_order_minimize">Tổng giá trị đơn hàng tối thiểu</label>
                                                                                <div class="input-group">
                                                                                    <div class="input-group-addon"><i class="icon-lock"></i></div>
                                                                                    <input type="text" class="form-control" id="total_order_minimize" placeholder="2000" value="">
                                                                                </div>
                                                                            </div>
                                                                            <div class="form-group">
                                                                                <label class="control-label mb-10" for="max_discount">Giảm tối đa</label>
                                                                                <div class="input-group">
                                                                                    <div class="input-group-addon"><i class="icon-lock"></i></div>
                                                                                    <input type="text" class="form-control" id="max_discount" placeholder="2000" value="">
                                                                                </div>
                                                                            </div>                                                                      
                                                                        </div>
                                                                        <div class="modal-footer">
                                                                                <button type="submit" class="btn btn-success waves-effect" id="save-new-promotion">Save</button>
                                                                                <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">Cancel</button>
                                                                            </div>			
                                                                    </form>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                                <!-- /.modal-content -->
                            </div>
                            <!-- /.modal-dialog -->
                        </div>
                    <!-- /modal -->
                    <!-- Row -->
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="panel panel-default card-view">
                                <div class="panel-wrapper collapse in">
                                    <div class="panel-body row">
                                        <div class="table-wrap">
                                            <div class="table-responsive">
                                                <table class="table display mb-30" cellspacing="0" width="100%" id="table-promotions">
                                                    <thead>
                                                        <tr>
                                                            <th>Mã khuyến mãi</th>
                                                            <th>Mô tả</th>
                                                            <th>Loại</th>
                                                            <th>Giảm giá</th>
                                                            <th>Giới hạn</th>
                                                            <th>Đã sử dụng</th>
                                                            <th>Ngày bắt đầu</th>
                                                            <th>Ngày kết thúc</th>
                                                            <th>Đơn hàng tối thiểu</th>
                                                            <th>Giảm tối đa</th>
                                                            <th>Chức năng</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                    </tbody>
                                                    <tfoot>
                                                        <tr>
                                                            <th>Mã khuyến mãi</th>
                                                            <th>Mô tả</th>
                                                            <th>Loại</th>
                                                            <th>Giảm giá</th>
                                                            <th>Giới hạn</th>
                                                            <th>Đã sử dụng</th>
                                                            <th>Ngày bắt đầu</th>
                                                            <th>Ngày kết thúc</th>
                                                            <th>Đơn hàng tối thiểu</th>
                                                            <th>Giảm tối đa</th>
                                                            <th>Chức năng</th>
                                                        </tr>
                                                    </tfoot>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- /Row -->
                        <!-- Footer -->
                        <footer class="footer container-fluid pl-30 pr-30">
                            <div class="row">
                                <div class="col-sm-12">
                                    <p>2018 &copy; Alomobile</p>
                                </div>
                            </div>
                        </footer>
                        <!-- /Footer -->    
                    </div>
                    <!-- /Main Content -->
                </div>
                <!-- /#wrapper -->
                <% include layouts/footer %>
                               
                <!-- Moment JavaScript -->
                <script type="text/javascript" src="/static/admin/libs/moment/min/moment-with-locales.min.js"></script>

                 <!-- Bootstrap Daterangepicker JavaScript -->
                 <script type="text/javascript" src="/static/admin/libs/bootstrap-daterangepicker/daterangepicker.js"></script>
				
		        <!-- Bootstrap Datetimepicker JavaScript -->
                <script type="text/javascript" src="/static/admin/libs/eonasdan-bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script>
                
                <script type="text/javascript" src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
                    <script>

                        function numberWithCommas(x) {
                            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                        }

                        jQuery(document).ready(() => {    
                            $('#add-promotion-modal').on('shown.bs.modal', function() {
                                $('.input-daterange-timepicker').daterangepicker({
                                    timePicker: true,
                                    format: 'MM/DD/YYYY HH:MM',
                                    startDate: moment().startOf('hour'),
                                    timePicker12Hour: false,
                                    timePickerSeconds: false,
                                    buttonClasses: ['btn', 'btn-sm'],
                                    applyClass: 'btn-info',
                                    cancelClass: 'btn-default',
                                    container: '#add-promotion-modal modal-body'
                                });                                
                            });
                        });

                        var tableUsers = $("#table-promotions");

                        (function (table, $) {
                            $.get('/api/v1/get-promotions', (data) => {
                                if (data.promotions && data.promotions.length > 0) {
                                    var items = ``;

                                    data.promotions.forEach(promotion => {
                                        var start_at, finish_at, start_at_string, finish_at_string;
                                       
                                        try {
                                            start_at = new Date(promotion.start_at);
                                            finish_at = new Date(promotion.finish_at);
                                        } catch (error) {
                                            
                                        }

                                        if (start_at) {
                                            start_at_string = `${start_at.getHours()}:${start_at.getMinutes()} ${start_at.getDate()}/${start_at.getMonth() + 1}/${start_at.getFullYear()}`
                                        }
                                        
                                        if (finish_at) {
                                            finish_at_string = `${finish_at.getHours()}:${finish_at.getMinutes()} ${finish_at.getDate()}/${finish_at.getMonth() + 1}/${finish_at.getFullYear()}`
                                        }                                       
                                        

                                        items += `
                                             <tr role="row" id="${promotion._id}"> 
                                               
                                                <td class="txt-dark">
                                                    ${promotion.code}     
                                                </td>
                                                <td class="txt-dark">
                                                    ${promotion.description || ""}
                                                </td>
                                                <td class="txt-dark">`

                                                if (promotion.type == 'percent') {
                                                    items+= `Theo phần trăm`
                                                } else {
                                                    items+= `Theo giá tiền`
                                                }
                                                    
                                                items+=`</td>
                                                <td class="txt-dark">`

                                                if (promotion.type == 'percent') {
                                                    items+= `${promotion.discount} %`
                                                } else {
                                                    items+= `${numberWithCommas(promotion.discount)} VNĐ`
                                                }

                                                    
                                                items += `</td>
                                                <td class="txt-dark">
                                                    ${promotion.limit || "Không giới hạn"}
                                                </td>
                                                <td class="txt-dark">
                                                    ${promotion.used || 0}
                                                </td>
                                                <td class="txt-dark">
                                                    ${start_at_string || "Không giới hạn"}
                                                </td>
                                                <td class="txt-dark">
                                                    ${finish_at_string || "Không giới hạn"}
                                                </td>
                                                <td class="txt-dark">`  
                                                    if (promotion.totalMinOrder && promotion.totalMinOrder != 0) {
                                                        items += `${numberWithCommas(promotion.totalMinOrder) || 0} VNĐ`
                                                    } else {
                                                        items += `Không giới hạn`;
                                                    }

                                                items += `</td>
                                                <td class="txt-dark">`
                                                    if (promotion.maxDiscount && promotion.maxDiscount != 0) {
                                                        items += `${numberWithCommas(promotion.maxDiscount) || 0} VNĐ`
                                                    } else {
                                                        items += `Không giới hạn`;
                                                    }
                                                items += `</td>
                                                <td class="action-promotion">
                                                    <a href="javascript:void(0)" class="text-inverse pr-10 edit-promotion" title="Chỉnh sửa khuyến mãi">
                                                        <i class="zmdi zmdi-edit txt-warning"></i>
                                                    </a>
                                                    <a href="javascript:void(0)" class="text-inverse delete-promotion" title="Xoá khuyến mãi">
                                                        <i class="zmdi zmdi-delete txt-danger"></i>
                                                    </a>
                                                </td>
                                            </tr>
                                        `
                                    });

                                    table.find('tbody').append(items);
                                }

                                table.DataTable({
                                    "language": {
                                        "lengthMenu": "Hiển thị _MENU_ dòng trên một trang",
                                        "zeroRecords": "Không có dữ liệu",
                                        "info": "Đang ở trang thứ _PAGE_ của _PAGES_ trang",
                                        "infoEmpty": "Dữ liệu hiện không sẵn có",
                                        "infoFiltered": "(đã lọc từ _MAX_ khuyến mãi hiện có)"
                                    }
                                });
                            });                           
                                                      
                        })(tableUsers, jQuery);
                    </script>
                    <script type="text/javascript">
                        function showNotifier(status, content) {
                            swal('Thông báo', content, status)
                        }

                        function confirmDelete(cb) {
                            swal({
                                    title: "Bạn có muốn xoá không?",
                                    text: "Nhấn vào 'Xoá ngay' nếu bạn muốn xoá khuyến mãi này",
                                    icon: "info",
                                    buttons: {
                                        cancel: true,
                                        delete: {
                                            text: "Xoá ngay",
                                            value: 'delete',
                                            className: 'btn-danger'
                                        }
                                    },
                            })
                            .then((value) => {
                                switch (value) {     
                                    case "delete":
                                        return cb(true);
                                        break;                   
                                    default:
                                        return cb(false);
                                        break;
                                }
                            }); 
                        }

                    </script>
                    <script>                        

                        jQuery(document).ready(($) => {

                            $('#promotion-add').click((e) => {
                                $("#add-promotion-modal").modal('show');
                            });

                            $("#table-promotions tbody").delegate('.delete-promotion', 'click', (e) => {

                                e.preventDefault();

                                var row = $(e.currentTarget.parentElement.parentElement);

                                confirmDelete((action) => {
                                    if (!action) {
                                        return
                                    }
                                    $.ajax({
                                        url: '/api/v1/promotion',
                                        data: {
                                            id: $(row).attr('id')
                                        },
                                        method: "DELETE",
                                        success: (data) => {
                                            if (data.error) {
                                                showNotifier('error', data.error);
                                                return
                                            }
                                            location.reload();
                                        },
                                        error: (err) => {                                                    
                                            swal('Oops', err.status == 403 ? 'Bạn không có quyền sử dụng chức năng này' : 'Lỗi không xác định hoặc bạn không có quyền thực hiện chức năng này.', 'error') 
                                        }
                                    })                                    
                                });
                            });

                            $('form').submit((e) => {

                                e.preventDefault();

                                var modal = $('#add-promotion-modal');
                                
                                var code = $('#promo_code').val();
                                var description = $('#description_promo').val();
                                var start_at = $('.input-daterange-timepicker').data('daterangepicker').startDate._d;                                
                                var start_time = new Date(start_at).getTime();
                                var finish_at = $('.input-daterange-timepicker').data('daterangepicker').endDate._d;                                
                                var finish_time = new Date(finish_at).getTime();
                                var type = $(modal).find('input[type="radio"]:checked').val();
                                var discount = $('#discount_promo').val();
                                var limit = $("#limit_promo").val();
                                var totalMinOrder = $("#total_order_minimize").val();
                                var maxDiscount = $("#max_discount").val();                                

                                var newPromotion = {
                                    code: code,
                                    description: description,
                                    discount: discount,
                                    type: type,
                                    limit: limit,
                                    totalMinOrder: totalMinOrder,
                                    start_at: start_time,
                                    finish_at: finish_time,
                                    maxDiscount: maxDiscount
                                }

                                $.ajax({
                                    url: "/api/v1/promotion",
                                    data: newPromotion,
                                    method: "POST",
                                    success: (data) => {
                                        if (data.error) {
                                            showNotifier('error', data.error);
                                        } else {
                                            window.location.reload();                                            
                                        }
                                    },
                                    error: (err) => {
                                        showNotifier('error', err.status == 403 ? 'Bạn không có quyền sử dụng chức năng này' : 'Lỗi không xác định hoặc bạn không có quyền thực hiện chức năng này.');
                                    }
                                })
                            })

                            $('#discount_promo').on('keyup keydown', (e) => {                           
                                var keyCode = (e.keyCode ? e.keyCode : e.which); 
                                if (keyCode > 47 && keyCode < 58) {
                                    
                                } else {
                                    if (keyCode != 8) {
                                        e.preventDefault();
                                    }                                    
                                }   
                                
                                if ($('#add-promotion-modal').find('input[type="radio"]:checked').attr('id') == 'price') { 
                                    $('#max_discount').val($(e.currentTarget).val());
                                }
                            });                            
                        });

                    </script>
</body>
<style>
        .daterangepicker {
          z-index: 1600 !important; /* has to be larger than 1050 */
        }
    </style>
</html>