<!doctype html>
<html lang="vi">
<head>
    <title>Giỏ hàng</title>
    <meta name="description" content="">
    <meta name="keywords" content="">
    
    <%- include layouts/head %>
    
</head>

<body id="cart" class="lang-en country-us currency-eur layout-full-width page-cart tax-display-disabled cart-empty">
    <main>
        <header id="header">
            <div class="header-banner">
            </div>
            <%- include layouts/header-nav %>
            <%- include layouts/header-top %>
            <%- include layouts/header-bottom %>
        </header>
        <aside id="notifications">
            <div class="container">
            </div>
        </aside>
        <div class="breadcrumb_container">
            <div class="container">
                <nav data-depth="1" class="breadcrumb hidden-sm-down">
                    <ol itemscope itemtype="http://schema.org/BreadcrumbList">
                        <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
                            <a itemprop="item" href="index.html">
                                <span itemprop="name">Home</span>
                            </a>
                            <meta itemprop="position" content="1">
                        </li>
                    </ol>
                </nav>
            </div>
        </div>
        <section id="wrapper">
            <div class="container">
                <div class="row">
                    <div id="content-wrapper" class="col-xs-12">
                        <section id="main">
                            <div class="cart-grid row">
                                <!-- Left Block: cart product informations & shpping -->
                                <div class="cart-grid-body col-xs-12 col-lg-8">
                                    <!-- cart products detailed -->
                                    <div class="card cart-container">
                                        <div class="card-block">
                                            <h1 class="h1">Giỏ hàng của bạn</h1>
                                        </div>
                                        <hr class="separator">
                                        <div class="cart-overview js-cart" >
                                            
                                        </div>
                                    </div>
                                    <a class="label" href="/">
                                        <i class="material-icons">chevron_left</i>Tiếp tục mua sắm
                                    </a>
                                    <!-- shipping informations -->
                                </div>
                                <!-- Right Block: cart subtotal & cart total -->
                                <div class="cart-grid-right col-xs-12 col-lg-4">
                                    <div class="card cart-summary">
                                        <div class="cart-detailed-totals">
                                            <div class="card-block">
                                                <div class="cart-summary-line" id="cart-subtotal-products">
                                                    <span class="label js-subtotal" data-total-quantity="0">
                                                        0 sản phẩm
                                                    </span>
                                                    <span class="value" data-raw-price="0">0 VNĐ</span>
                                                </div>
                                                <div class="cart-summary-line" id="cart-subtotal-shipping">
                                                    <span class="label">
                                                        Phí vận chuyển
                                                    </span>
                                                    <span class="value">Miễn phí</span>
                                                    <div><small class="value"></small></div>
                                                </div>
                                            </div>
                                            <hr class="separator">
                                            <div class="card-block">
                                                <div class="cart-summary-line cart-total">
                                                    <span class="label">Tổng đơn hàng</span>
                                                    <span class="value" data-total-raw-price="0">0 VNĐ</span>
                                                </div>
                                            </div>
                                            <hr class="separator">
                                        </div>
                                        <div class="checkout text-sm-center card-block">
                                            <button type="button" class="btn btn-primary">Tiến hành thanh toán</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
        </section>
        <%- include layouts/footer %>
    </main>    
    <script type="text/javascript" src="/static/js/custom.js"></script>
    <div class="back-top"><a href="#" class="back-top-button"></a></div>
</body>
<script type="text/javascript">

    getProductsCart(null, (data) => {
        var items = '<ul class="cart-items">';

        var products = data.products;

        var cartOverView = $('#main div.cart-overview');
        var cartSummary = $('#main div.cart-summary');

        if (!Array.isArray(products) || products.length == 0) { 
            $(cartOverView).append(`<span class="no-items" style="text-align: center;">Không có sản phẩm nào trong giỏ hàng</span>`);
            $('#main').find('button').addClass('disabled')
            return 
        }

        var totalPrices = 0;

        products.forEach(product => {
            totalPrices += product.quantity * product.detail.price
            items+= `
                <li class="cart-item" data-id-product="${product._id}">
                    <div class="product-line-grid">
                            <!--  product left content: image-->
                        <div class="product-line-grid-left col-md-3 col-xs-4">
                            <span class="product-image media-middle">
                                <img src="${product.images[0].url}" alt="${product.images[0].alt}">
                            </span>
                        </div>
                            <!--  product left body: description -->
                        <div class="product-line-grid-body col-md-4 col-xs-8">
                            <div class="product-line-info">
                                <a class="label" href="/${product.alias}-${product._id}" data-id_customization="0">${product.name}</a>
                            </div>
                            <div class="product-line-info product-price h6 has-discount" style="margin: 5px 0px 5px 0px;">
                                <div class="current-price">
                                    <span class="price" style="font-size: 25px;">${numberWithCommas(product.detail.price) + " VNĐ"}</span>
                                </div>
                            </div>
                            <br>
                            <div class="product-line-info">
                                <span class="label">Màu:</span>
                                <div style="background-color: ${product.detail.color.hex}; border-radius: 50%; width: 20px; height: 20px; display: inline-block; border-width: 1px; border-style: solid; border-color: grey; margin-left: 5px ;position: absolute;" title="Cosmos"></div>
                            </div>
                        </div>
                        <!--  product left body: description -->
                        <div class="product-line-grid-right product-line-actions col-md-5 col-xs-12">
                            <div class="row">
                                <div class="col-xs-4 hidden-md-up"></div>
                                <div class="col-md-10 col-xs-6">
                                    <div class="row">
                                        <div class="col-md-6 col-xs-6 qty">
                                            <input type="text" name="qty" id="${product._id}" value="${product.quantity}" class="input-group" min="1" aria-label="Quantity">
                                        </div>
                                        <div class="col-md-6 col-xs-2 price">
                                            <span class="product-price" style="line-height: 25px; font-size: 16px;">
                                                <strong data-raw-price="${product.quantity * product.detail.price}">
                                                        ${numberWithCommas(product.quantity * product.detail.price) + " VNĐ"}
                                                </strong>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2 col-xs-2 text-xs-right">
                                    <div class="cart-line-product-actions">
                                        <a class="remove-from-cart" href="javascript: void(0)" data-id-product="${product._id}" data-color-product="${product.detail.color.hex}" data-raw-price="${product.detail.price}">
                                        <i class="material-icons float-xs-left">delete</i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="clearfix"></div>
                    </div>
                </li>
            `
        });

        items+= '</ul>'

        $(cartOverView).append(items);

        //sub total prices
        $(cartSummary).find('div#cart-subtotal-products span.value').text(numberWithCommas(totalPrices) + " VNĐ");
        $(cartSummary).find('div#cart-subtotal-products span.value').attr('data-raw-price', totalPrices);

        //total prices            
        $(cartSummary).find('div.cart-total span.value').text(numberWithCommas(totalPrices) + " VNĐ");
        $(cartSummary).find('div.cart-total span.value').attr('data-total-raw-price', totalPrices);

        //total item            
        $(cartSummary).find('div#cart-subtotal-products span.js-subtotal').text(products.length + " sản phẩm");
        $(cartSummary).find('div#cart-subtotal-products span.js-subtotal').attr('data-total-quantity', products.length );

        //init touchSpin
        products.forEach(product => {                
            $(`input[id=${product._id}]`).TouchSpin({ 
                verticalbuttons: true, 
                verticalupclass: "material-icons touchspin-up", 
                verticaldownclass: "material-icons touchspin-down", 
                buttondown_class: "btn btn-touchspin js-touchspin", 
                buttonup_class: "btn btn-touchspin js-touchspin", 
                min: 1,
               // max: product.detail.quantity 
            });
        });

        $('.cart-items').bind('DOMSubtreeModified', (e) => {
            var product = $(e.currentTarget).find('li');
            var emptyBlock = `<span class="no-items" style="text-align: center;">Không có sản phẩm nào trong giỏ hàng</span>`
            if (!product || product.length == 0) {
                $(e.currentTarget.parentElement).append(emptyBlock)
                $('#main div.checkout button').addClass('disabled');
            } else {
                $(e.currentTarget.parentElement).remove('span.no-items');
            }
        }); 
    });

    $('.cart-overview').delegate('a.remove-from-cart', 'click', (e) => {
            var id = $(e.currentTarget).attr('data-id-product'),
            color = $(e.currentTarget).attr('data-color-product'),
            price = $(e.currentTarget).attr('data-raw-price'),
            quantity = $(e.currentTarget.parentElement.parentElement.parentElement).find(`input#${id}`).val();

            //remove it in localStorage
            if (removeFromCart(id, color)) {

                var cartSummary = $('.cart-summary');

                var totalItems = $(cartSummary).find('div#cart-subtotal-products span.js-subtotal').attr('data-total-quantity');
                var totalSubPrices = $(cartSummary).find('div#cart-subtotal-products span.value').attr('data-raw-price');
                var totalPrices = $(cartSummary).find('div.cart-total span.value').attr('data-total-raw-price');

                //adjust in summary cart
                $(cartSummary).find('div#cart-subtotal-products span.js-subtotal').attr('data-total-quantity', totalItems - 1);
                $(cartSummary).find('div#cart-subtotal-products span.js-subtotal').text(totalItems - 1 + " sản phẩm");
                $(cartSummary).find('div#cart-subtotal-products span.value').text(numberWithCommas(totalSubPrices - (quantity * price)) + " VNĐ")
                $(cartSummary).find('div#cart-subtotal-products span.value').attr('data-raw-price', totalSubPrices - (quantity * price))
                $(cartSummary).find('div.cart-total span.value').attr('data-total-raw-price', totalSubPrices - (quantity * price));
                $(cartSummary).find('div.cart-total span.value').text(numberWithCommas(totalSubPrices - (quantity * price)) + " VNĐ")

                //adjust in header
                fetchCartPreview();

                $('.cart-overview').find(`li[data-id-product=${id}]`).remove();
            } 
        });

    $(document).ready(($) => {
        
    });

</script>

    
</html>